<div class="stronghold-viewer">
    <div class="viewer-header">
        <h2><i class="fas fa-castle"></i> Party Strongholds</h2>
        <div class="header-actions">
            {{#if isGM}}
            <button class="reload-clients" title="Reload all connected clients">
                <i class="fas fa-bolt"></i>
            </button>
            {{/if}}
            <button class="refresh-bonuses" title="Refresh stronghold data">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    {{#if hasStrongholds}}
    <div class="character-info">
        <p><strong>Character:</strong> {{characterName}}</p>
        {{#if characterClasses}}
        <p><strong>Classes:</strong> {{#each characterClasses}}{{this}}{{#unless @last}}, {{/unless}}{{/each}} (Level {{characterLevel}})</p>
        {{/if}}
        {{#if (eq systemId "dnd5e")}}
        <p><em>Showing D&D 5e stronghold bonuses applicable during extended rests</em></p>
        {{else}}
        <p><em>System: {{systemId}} - Some features may require D&D 5e system</em></p>
        {{/if}}
    </div>

    <div class="strongholds-list">
        {{#each strongholds}}
        <div class="stronghold-item type-{{type}}">
            <div class="stronghold-header">
                <div class="stronghold-title">
                    <h3>{{name}}</h3>
                    <div class="stronghold-meta">
                        <span class="stronghold-type">{{capitalize type}}</span>
                        {{#if classFlavor}}
                        <span class="stronghold-class">{{#if classFlavorDisplay}}{{classFlavorDisplay}}{{else}}{{capitalize classFlavor}}{{/if}}</span>
                        {{/if}}
                        <span class="stronghold-level">Level {{level}}</span>
                    </div>
                </div>

                <button class="bonus-toggle" data-stronghold-id="{{id}}" title="Show details">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>

            <div class="stronghold-summary">
                <table class="sg-table sg-table--compact sg-table--striped">
                    <thead>
                        <tr>
                            <th><i class=\"fas fa-chess-rook\"></i> Type</th>
                            <th><i class=\"fas fa-hat-wizard\"></i> Class</th>
                            <th><i class=\"fas fa-signal\"></i> Level</th>
                            <th><i class=\"fas fa-user-friends\"></i> Followers</th>
                            <th><i class=\"fas fa-coins\"></i> Total Value</th>
                            <th><i class=\"fas fa-toggle-on\"></i> Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{capitalize type}}</td>
                            <td>
                                {{#if classFlavorDisplay}}{{classFlavorDisplay}}{{else}}
                                  {{#if classFlavor}}{{capitalize classFlavor}}{{else}}—{{/if}}
                                {{/if}}
                            </td>
                            <td class="cell-num">{{level}} / 5</td>
                            <td>{{#if classSummary.followers}}{{classSummary.followers}}{{else}}—{{/if}}</td>
                            <td class="cell-num">{{#if totalCostPaid}}{{formatNumber totalCostPaid}} gp{{else}}—{{/if}}</td>
                            <td class="cell-num"><i class="fas fa-check-circle" title="Active"></i></td>
                        </tr>
                        {{#if description}}
                        <tr class="row-note">
                            <td colspan="6" class="cell-note">{{description}}</td>
                        </tr>
                        {{/if}}
                        {{#if typeDescription}}
                        <tr class="row-note">
                            <td colspan="6" class="cell-note"><em>{{typeDescription}}</em></td>
                        </tr>
                        {{/if}}
                    </tbody>
                </table>

                {{#if classFlavorDisplay}}
                <div class="class-flavor-summary">
                    <span class="class-flavor-badge" title="Class Flavor"><i class="fas fa-hat-wizard"></i> {{classFlavorDisplay}}</span>
                    {{#if (getClassFlavorDescription classFlavor)}}
                    <p class="class-flavor-text">{{getClassFlavorDescription classFlavor}}</p>
                    {{/if}}
                </div>
                {{/if}}

                {{#if actionPreview}}
                <div class="action-preview">
                    {{#each actionPreview}}
                    <span class="action-chip" title="Stronghold action">{{this}}</span>
                    {{/each}}
                </div>
                {{/if}}
            </div>

            <div class="bonus-summary">
                {{#if customBonuses}}
                <p><strong>{{customBonuses.length}} custom bonus{{#unless (eq customBonuses.length 1)}}es{{/unless}} available</strong></p>
                {{#if hasClassBonuses}}
                <p class="class-bonus-note">
                    <i class="fas fa-star"></i> Includes class-flavored stronghold
                    {{#if classFlavorDisplay}}
                      — <em>{{classFlavorDisplay}}</em>
                    {{/if}}
                    {{#if (and classFlavor classFlavorDisplay)}}
                      <br><span class="class-flavor-desc">{{getClassFlavorDescription classFlavor}}</span>
                    {{/if}}
                </p>
                {{/if}}
                {{else}}
                <p class="no-bonuses">No custom bonuses have been added yet</p>
                {{/if}}
            </div>

            <div class="bonus-details" style="display: none;">
                <div class="collapsible">
                    <button class="section-toggle" type="button"><i class="fas fa-chevron-right"></i> Mechanics</button>
                    <div class="section-body" style="display: none;">
                        {{#if typeSummary}}
                        <div class="mechanics-block type-summary">
                            <table class="sg-table sg-table--compact sg-table--striped">
                                <thead>
                                    <tr>
                                        <th colspan="2"><i class="fas fa-globe"></i> Demesne Effects</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each typeSummary.demesne}}
                                    <tr><td colspan="2">{{this}}</td></tr>
                                    {{/each}}
                                    <tr><th colspan="2"><i class="fas fa-fist-raised"></i> Stronghold Actions</th></tr>
                                    {{#each typeSummary.actions}}
                                    <tr><td colspan="2">{{this}}</td></tr>
                                    {{/each}}
                                </tbody>
                            </table>
                        </div>
                        {{/if}}

                        {{#if classSummary}}
                        <div class="mechanics-block class-summary">
                            <table class="sg-table sg-table--compact sg-table--striped">
                                <tbody>
                                    {{#if classSummary.followers}}
                                    <tr>
                                        <th style="width: 180px"><i class="fas fa-user-friends"></i> Followers</th>
                                        <td>{{classSummary.followers}}</td>
                                    </tr>
                                    {{/if}}
                                    {{#if classSummary.actions}}
                                    <tr><th colspan="2"><i class="fas fa-bolt"></i> Class Actions</th></tr>
                                    {{#each classSummary.actions}}
                                    <tr><td colspan="2">{{this}}</td></tr>
                                    {{/each}}
                                    {{/if}}
                                    {{#if classSummary.tables}}
                                    <tr><th colspan="2"><i class="fas fa-table"></i> Tables</th></tr>
                                    {{#each classSummary.tables}}
                                    <tr><td colspan="2">{{this}}</td></tr>
                                    {{/each}}
                                    {{/if}}
                                </tbody>
                            </table>
                        </div>
                        {{/if}}
                    </div>
                </div>

                <div class="collapsible">
                    <button class="section-toggle" type="button"><i class="fas fa-chevron-right"></i> Custom Bonuses</button>
                    <div class="section-body" style="display: none;">
                        {{#if customBonuses}}
                        <table class="sg-table sg-table--compact sg-table--striped">
                            <thead>
                                <tr>
                                    <th>Bonus</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each customBonuses}}
                                <tr>
                                    <td>
                                        <strong>{{name}}</strong>
                                        <div class="cell-note">{{description}}</div>
                                    </td>
                                    <td>
                                        {{#if partyWide}}
                                            <span class="party-bonus"><i class="fas fa-users"></i> Party-wide</span>
                                        {{else}}
                                            <span class="class-bonus"><i class="fas fa-user"></i> Character-specific</span>
                                        {{/if}}
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                        {{else}}
                        <p class="no-custom-bonuses">No custom bonuses have been added by the GM yet.</p>
                        {{/if}}
                    </div>
                </div>
            </div>
        </div>
        {{/each}}
    </div>

    <div class="extended-rest-info">
        <div class="info-box">
            <h4><i class="fas fa-bed"></i> Extended Rest Bonuses</h4>
            <p>These bonuses are applied automatically when you complete an extended rest (if auto-apply is enabled).</p>
            <p><strong>Party-wide bonuses</strong> apply to all characters, while <strong>class-specific bonuses</strong> only apply to matching classes.</p>
        </div>
    </div>

    {{else}}
    <div class="no-strongholds">
        <div class="empty-state">
            <i class="fas fa-castle fa-3x"></i>
            <h3>No Active Strongholds</h3>
            <p>Your party doesn't have any active strongholds yet.</p>
            <p>Ask your GM to create and activate strongholds to gain bonuses during extended rests.</p>
        </div>
    </div>
    {{/if}}
</div>